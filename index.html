<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cestas ‚Äî Vendas simples</title>
<style>
  :root{
    --bg:#f7f8fb; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --primary:#2563eb; --soft:#e9f0ff; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    --card:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; overflow-x:hidden}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .top{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:9}
  .top .wrap{display:flex;gap:8px;align-items:center;justify-content:space-between}
  h1{font-size:18px;margin:12px 0}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px 12px;border-radius:10px;cursor:pointer;white-space:nowrap}
  .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .btn.soft{background:var(--soft);border-color:var(--soft);color:#1e3a8a}
  .btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
  .btn.warn{background:var(--warn);color:#fff;border-color:var(--warn)}
  .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media(max-width:720px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;overflow:hidden}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row > *{flex:1}
  label{font-weight:600;margin:8px 0 4px;display:block}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  table{width:100%;border-collapse:collapse;table-layout:fixed;min-width:640px}
  th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;word-wrap:break-word;overflow-wrap:anywhere}
  .stack{display:flex;flex-direction:column;gap:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .hidden{display:none}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted);font-size:12px}
  .route{font-weight:700}
  .footer{margin-top:24px;display:flex;gap:8px;flex-wrap:wrap}
  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.3s}
  .toast.show{opacity:1;pointer-events:auto}
  .badge{font-size:12px;padding:2px 6px;border-radius:8px;background:var(--soft);color:#1e3a8a;border:1px solid var(--soft)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .link{color:var(--primary);text-decoration:none}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .cta3{display:flex;gap:8px;flex-wrap:wrap}
  /* >>> Responsivo de tabela: impede vazamento lateral no mobile */
  .table-scroll{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
</style>
</head>
<body>
  <div class="top">
    <div class="wrap">
      <h1>üß∫ Cestas ‚Äî Painel</h1>
      <div class="toolbar">
        <button class="btn soft" id="btnHome">In√≠cio</button>
        <button class="btn" id="btnVender">Vender</button>
        <button class="btn" id="btnClientes">Clientes</button>
        <button class="btn" id="btnProdutos">Produtos</button>
        <button class="btn primary" id="btnRelatorio">Relat√≥rio</button>
        <button class="btn" id="btnBackup">Backup</button>
        <input type="file" id="fileImport" class="hidden" accept=".json">
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- HOME -->
    <div id="viewHome" class="stack">
      <div class="card">
        <div class="grid">
          <button class="btn primary" id="goVender">Vender</button>
          <button class="btn" id="goClientes">Cliente</button>
          <button class="btn" id="goProdutos">Produto</button>
          <button class="btn soft" id="goRelatorio">Relat√≥rio de vendas</button>
        </div>
      </div>
      <div class="card">
        <b>Dica r√°pida:</b> cadastre produtos e clientes primeiro. Em <i>Relat√≥rio</i>, compartilhe o pedido por WhatsApp ‚Äî o link abre o pedido com <b>Ligar</b>, <b>WhatsApp</b> e <b>Google Maps</b>.
      </div>
    </div>

    <!-- VENDER -->
    <div id="viewVender" class="stack hidden">
      <div class="card">
        <h3>Vender</h3>
        <div class="grid">
          <div>
            <label>Cliente</label>
            <select id="saleClient"></select>
          </div>
          <div>
            <label>Pagamento</label>
            <select id="salePay">
              <option value="Cart√£o">Cart√£o</option>
              <option value="Dinheiro">Dinheiro</option>
              <option value="PIX">PIX</option>
              <option value="Fiado">Fiado</option>
            </select>
          </div>
          <div>
            <label>Rota</label>
            <select id="saleRoute">
              <option value="Coxip√≥">Coxip√≥</option>
              <option value="VG">VG</option>
              <option value="Cuiab√°">Cuiab√°</option>
              <option value="CPA">CPA</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>
        <div class="grid">
          <div>
            <label>Produto</label>
            <select id="saleProduct"></select>
          </div>
          <div>
            <label>Qtd</label>
            <input type="number" id="saleQty" min="1" value="1">
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="btnAddItem">Adicionar item</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="table-scroll">
          <table id="cartTable">
            <thead><tr><th>Produto</th><th>Qtd</th><th>Pre√ßo</th><th>Total</th><th></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><th colspan="3" style="text-align:right">Total</th><th id="cartTotal">$ 0,00</th><th></th></tr></tfoot>
          </table>
        </div>
        <div class="footer">
          <button class="btn ok" id="btnSaveSale">Salvar pedido</button>
          <span class="pill">Pedidos salvos ficam em Relat√≥rio</span>
        </div>
      </div>
    </div>

    <!-- CLIENTES -->
    <div id="viewClientes" class="stack hidden">
      <div class="card">
        <h3>Novo cliente</h3>
        <div class="grid">
          <div><label>Nome</label><input id="cNome"></div>
          <div><label>Telefone (apenas n√∫meros)</label><input id="cTel" placeholder="65999999999"></div>
          <div><label>Endere√ßo</label><input id="cEnd"></div>
          <div><label>Complemento</label><input id="cComp"></div>
        </div>
        <div class="footer">
          <button class="btn ok" id="btnAddCliente">Salvar cliente</button>
          <label class="btn">
            Subir CSV de clientes
            <input type="file" id="csvClientes" accept=".csv" class="hidden">
          </label>
          <span class="pill">CSV: nome,telefone,endereco,complemento</span>
        </div>
      </div>

      <div class="card">
        <h3>Clientes</h3>
        <div class="table-scroll">
          <table id="tblClientes"><thead><tr><th>Nome</th><th>Telefone</th><th>Endere√ßo</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- PRODUTOS -->
    <div id="viewProdutos" class="stack hidden">
      <div class="card">
        <h3>Novo produto</h3>
        <div class="grid">
          <div><label>Nome</label><input id="pNome"></div>
          <div><label>Valor (R$)</label><input id="pValor" type="number" step="0.01" min="0"></div>
        </div>
        <div class="footer">
          <button class="btn ok" id="btnAddProduto">Salvar produto</button>
        </div>
      </div>

      <div class="card">
        <h3>Produtos</h3>
        <div class="table-scroll">
          <table id="tblProdutos"><thead><tr><th>Nome</th><th>Valor</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- RELAT√ìRIO -->
    <div id="viewRelatorio" class="stack hidden">
      <div class="card">
        <h3>Relat√≥rio de vendas por rota</h3>
        <div id="relContent" class="stack"></div>
      </div>
    </div>

    <!-- VISOR DE PEDIDO COMPARTILHADO -->
    <div id="viewPedido" class="stack hidden">
      <div class="card" id="pedidoCard">
        <!-- preenchido via hash #pedido=... -->
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

<script>
/* ===============================
   STORAGE & ESTADO
=================================*/
const KEY = {
  clientes: "cx_clientes",
  produtos: "cx_produtos",
  pedidos:  "cx_pedidos"
};

const state = {
  clientes: load(KEY.clientes, []),
  produtos: load(KEY.produtos, []),
  pedidos:  load(KEY.pedidos,  []),
  cart: []
};

function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }
function load(k, fallback){ try{ return JSON.parse(localStorage.getItem(k)||"null") ?? fallback }catch{ return fallback } }
function saveAll(){ localStorage.setItem(KEY.clientes, JSON.stringify(state.clientes));
                    localStorage.setItem(KEY.produtos, JSON.stringify(state.produtos));
                    localStorage.setItem(KEY.pedidos,  JSON.stringify(state.pedidos)); }

const BRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
function brl(n){ return BRL.format(+n||0) }
function telLink(num){ num = (num||"").replace(/\D+/g,""); if(!num) return null; if(num.length<=11) num = "55"+num; return "tel:+"+num }
function waLink(num,msg){
  const n = (num||"").replace(/\D+/g,""); 
  const base = `https://wa.me/`;
  if(!n){ return `${base}?text=${encodeURIComponent(msg||"")}` }
  const full = (n.length<=11? "55"+n : n);
  return `${base}${full}?text=${encodeURIComponent(msg||"")}`;
}
function mapsSearch(q){ return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q||"")}` }

/* ===============================
   NAVEGA√á√ÉO
=================================*/
const VIEWS = {
  home:     document.getElementById('viewHome'),
  vender:   document.getElementById('viewVender'),
  clientes: document.getElementById('viewClientes'),
  produtos: document.getElementById('viewProdutos'),
  rel:      document.getElementById('viewRelatorio'),
  pedido:   document.getElementById('viewPedido')
};
function show(which){
  Object.values(VIEWS).forEach(v=>v.classList.add('hidden'));
  which.classList.remove('hidden');
}

/* ===============================
   TOAST
=================================*/
const toastEl = document.getElementById('toast');
function toast(msg, ms=1400){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ms); }

/* ===============================
   CLIENTES
=================================*/
const elC = {
  nome: document.getElementById('cNome'),
  tel:  document.getElementById('cTel'),
  end:  document.getElementById('cEnd'),
  comp: document.getElementById('cComp'),
  csv:  document.getElementById('csvClientes'),
  tbl:  document.getElementById('tblClientes').querySelector('tbody'),
  selectForSale: document.getElementById('saleClient')
};

function renderClientes(){
  // preencher select venda
  elC.selectForSale.innerHTML = '';
  if(state.clientes.length===0){
    elC.selectForSale.innerHTML = '<option value="">-- cadastre clientes --</option>';
  }else{
    for(const c of state.clientes.slice().sort((a,b)=>a.nome.localeCompare(b.nome))){
      const opt = document.createElement('option');
      opt.value = c.id; opt.textContent = `${c.nome} ‚Äî ${c.telefone||''}`;
      elC.selectForSale.appendChild(opt);
    }
  }
  // tabela
  elC.tbl.innerHTML = '';
  for(const c of state.clientes){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${escapeHtml(c.nome)}" data-id="${c.id}" data-k="nome"></td>
      <td><input value="${escapeHtml(c.telefone||'')}" data-id="${c.id}" data-k="telefone"></td>
      <td><input value="${escapeHtml(c.endereco||'')}" data-id="${c.id}" data-k="endereco"></td>
      <td class="row" style="gap:6px;justify-content:flex-end">
        <button class="btn" data-edit="${c.id}">Salvar</button>
        <button class="btn danger" data-del="${c.id}">Excluir</button>
      </td>`;
    elC.tbl.appendChild(tr);
  }
}

function addCliente(){
  const nome = elC.nome.value.trim();
  if(!nome){ toast("Nome √© obrigat√≥rio"); return }
  const c = {
    id: uid(),
    nome,
    telefone: elC.tel.value.trim(),
    endereco: elC.end.value.trim(),
    complemento: elC.comp.value.trim()
  };
  state.clientes.push(c); saveAll(); renderClientes();
  elC.nome.value=''; elC.tel.value=''; elC.end.value=''; elC.comp.value='';
  toast("Cliente salvo");
}

function handleClientesTable(e){
  const idDel = e.target.getAttribute('data-del');
  const idEdit= e.target.getAttribute('data-edit');
  if(idDel){
    state.clientes = state.clientes.filter(x=>x.id!==idDel); saveAll(); renderClientes(); toast("Cliente removido"); return;
  }
  if(idEdit){
    // coletar campos da linha
    const inputs = elC.tbl.querySelectorAll(`input[data-id="${idEdit}"]`);
    const c = state.clientes.find(x=>x.id===idEdit); if(!c) return;
    inputs.forEach(inp => c[inp.getAttribute('data-k')] = inp.value.trim());
    saveAll(); renderClientes(); toast("Cliente atualizado"); return;
  }
}

function importClientesCSV(file){
  const reader = new FileReader();
  reader.onload = () => {
    const txt = reader.result;
    const lines = txt.split(/\r?\n/).filter(Boolean);
    let added = 0;
    for(const line of lines){
      const parts = line.split(/[,;]\s*/); // v√≠rgula ou ponto-e-v√≠rgula
      const [nome, telefone, endereco, complemento] = parts;
      if(nome){
        state.clientes.push({id:uid(), nome:nome.trim(), telefone:(telefone||'').trim(), endereco:(endereco||'').trim(), complemento:(complemento||'').trim()});
        added++;
      }
    }
    saveAll(); renderClientes();
    toast(`Importados ${added} clientes`);
  };
  reader.readAsText(file, 'utf-8');
}

/* ===============================
   PRODUTOS
=================================*/
const elP = {
  nome: document.getElementById('pNome'),
  valor: document.getElementById('pValor'),
  tbl: document.getElementById('tblProdutos').querySelector('tbody'),
  selectForSale: document.getElementById('saleProduct')
};

function renderProdutos(){
  // select para venda
  elP.selectForSale.innerHTML = '';
  if(state.produtos.length===0){
    elP.selectForSale.innerHTML = '<option value="">-- cadastre produtos --</option>';
  }else{
    for(const p of state.produtos.slice().sort((a,b)=>a.nome.localeCompare(b.nome))){
      const opt = document.createElement('option');
      opt.value = p.id; opt.textContent = `${p.nome} ‚Äî ${brl(p.valor)}`;
      elP.selectForSale.appendChild(opt);
    }
  }
  // tabela
  elP.tbl.innerHTML = '';
  for(const p of state.produtos){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${escapeHtml(p.nome)}" data-id="${p.id}" data-k="nome"></td>
      <td><input type="number" step="0.01" min="0" value="${+p.valor}" data-id="${p.id}" data-k="valor"></td>
      <td class="row" style="gap:6px;justify-content:flex-end">
        <button class="btn" data-edit="${p.id}">Salvar</button>
        <button class="btn danger" data-del="${p.id}">Excluir</button>
      </td>`;
    elP.tbl.appendChild(tr);
  }
}

function addProduto(){
  const nome = elP.nome.value.trim();
  const valor = parseFloat(elP.valor.value);
  if(!nome || isNaN(valor)){ toast("Informe nome e valor"); return }
  state.produtos.push({id:uid(), nome, valor: +valor});
  saveAll(); renderProdutos(); elP.nome.value=''; elP.valor.value='';
  toast("Produto salvo");
}

function handleProdutosTable(e){
  const idDel = e.target.getAttribute('data-del');
  const idEdit= e.target.getAttribute('data-edit');
  if(idDel){
    state.produtos = state.produtos.filter(x=>x.id!==idDel);
    state.cart = state.cart.filter(i=>i.productId!==idDel);
    saveAll(); renderProdutos(); renderCart(); toast("Produto removido"); return;
  }
  if(idEdit){
    const inputs = elP.tbl.querySelectorAll(`input[data-id="${idEdit}"]`);
    const p = state.produtos.find(x=>x.id===idEdit); if(!p) return;
    inputs.forEach(inp => {
      const k = inp.getAttribute('data-k');
      p[k] = (k==='valor') ? +parseFloat(inp.value||0) : inp.value.trim();
    });
    saveAll(); renderProdutos(); renderCart(); toast("Produto atualizado"); return;
  }
}

/* ===============================
   VENDER / CARRINHO
=================================*/
const elV = {
  pay: document.getElementById('salePay'),
  route: document.getElementById('saleRoute'),
  product: document.getElementById('saleProduct'),
  qty: document.getElementById('saleQty'),
  client: document.getElementById('saleClient'),
  add: document.getElementById('btnAddItem'),
  save: document.getElementById('btnSaveSale'),
  cartTbody: document.querySelector('#cartTable tbody'),
  cartTotal: document.getElementById('cartTotal')
};

function addToCart(){
  const pid = elV.product.value;
  const qty = Math.max(1, parseInt(elV.qty.value||'1',10));
  const prod = state.produtos.find(p=>p.id===pid);
  if(!prod){ toast("Selecione um produto"); return }
  const ex = state.cart.find(i=>i.productId===pid);
  if(ex){ ex.qty += qty } else { state.cart.push({productId:pid, qty, price: +prod.valor, name: prod.nome}) }
  renderCart(); toast("Item adicionado");
}

function renderCart(){
  elV.cartTbody.innerHTML='';
  let tot = 0;
  for(const it of state.cart){
    const line = it.qty * it.price; tot += line;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(it.name)}</td>
      <td><input type="number" min="1" value="${it.qty}" data-p="${it.productId}" class="mono"></td>
      <td>${brl(it.price)}</td>
      <td>${brl(line)}</td>
      <td><button class="btn danger" data-rm="${it.productId}">X</button></td>`;
    elV.cartTbody.appendChild(tr);
  }
  elV.cartTotal.textContent = brl(tot);
}

function handleCart(e){
  const rm = e.target.getAttribute('data-rm');
  if(rm){
    state.cart = state.cart.filter(i=>i.productId!==rm); renderCart(); return;
  }
  if(e.target.matches('input[type="number"][data-p]')){
    const pid = e.target.getAttribute('data-p');
    const it = state.cart.find(i=>i.productId===pid); if(!it) return;
    it.qty = Math.max(1, parseInt(e.target.value||'1',10)); renderCart();
  }
}

function saveSale(){
  const clientId = elV.client.value;
  const cli = state.clientes.find(c=>c.id===clientId);
  if(!cli){ toast("Selecione um cliente"); return }
  if(state.cart.length===0){ toast("Carrinho vazio"); return }
  const order = {
    id: uid(),
    ts: Date.now(),
    client: { id: cli.id, nome: cli.nome, telefone: cli.telefone||'', endereco: cli.endereco||'', complemento: cli.complemento||'' },
    items: state.cart.map(i=>({productId:i.productId, name:i.name, qty:i.qty, price:+i.price})),
    payment: elV.pay.value,
    route: elV.route.value,
    total: state.cart.reduce((s,i)=>s+i.qty*i.price,0)
  };
  state.pedidos.push(order); saveAll(); state.cart = []; renderCart();
  toast("Pedido salvo em Relat√≥rio");
}

/* ===============================
   RELAT√ìRIO
=================================*/
const relEl = document.getElementById('relContent');

function renderRelatorio(){
  // Agrupar por rota
  const byRoute = {};
  for(const o of state.pedidos){
    (byRoute[o.route] ||= []).push(o);
  }
  const routes = Object.keys(byRoute).sort();
  relEl.innerHTML = '';
  if(routes.length===0){
    relEl.innerHTML = '<div class="pill">Ainda sem pedidos.</div>';
    return;
  }

  for(const r of routes){
    const box = document.createElement('div');
    const pedidos = byRoute[r].slice().sort((a,b)=>b.ts-a.ts);
    const totalRoute = pedidos.reduce((s,o)=>s+o.total,0);
    box.className = 'card';
    box.innerHTML = `<div class="row" style="justify-content:space-between">
        <div><span class="route">Rota ${escapeHtml(r)}</span> ‚Ä¢ <span class="badge">${pedidos.length} pedidos</span></div>
        <div><b>Total: ${brl(totalRoute)}</b></div>
      </div>
      <div class="hr"></div>`;

    const wrap = document.createElement('div');
    wrap.className = 'table-scroll';

    const table = document.createElement('table');
    table.innerHTML = `<thead><tr><th>Quando</th><th>Cliente</th><th>Pagamento</th><th>Total</th><th></th></tr></thead>`;
    const tb = document.createElement('tbody');

    for(const o of pedidos){
      const when = new Date(o.ts).toLocaleString('pt-BR');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${when}</td>
        <td>${escapeHtml(o.client.nome)}</td>
        <td>${escapeHtml(o.payment)}</td>
        <td>${brl(o.total)}</td>
        <td class="row" style="justify-content:flex-end;gap:6px">
          <button class="btn" data-view="${o.id}">Ver</button>
          <button class="btn soft" data-share="${o.id}">Compartilhar</button>
          <button class="btn danger" data-del="${o.id}">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    }
    table.appendChild(tb);
    wrap.appendChild(table);
    box.appendChild(wrap);
    relEl.appendChild(box);
  }
}

function handleRelatorio(e){
  const id = e.target.getAttribute('data-del');
  const v  = e.target.getAttribute('data-view');
  const s  = e.target.getAttribute('data-share');
  if(id){
    state.pedidos = state.pedidos.filter(p=>p.id!==id); saveAll(); renderRelatorio(); toast("Pedido exclu√≠do"); return;
  }
  if(v){ openOrderViewer(v); return; }
  if(s){ shareOrder(s); return; }
}

function buildOrderPayload(order){
  // payload enxuto pro link
  const slim = {
    id: order.id,
    ts: order.ts,
    c: { n: order.client.nome, t: order.client.telefone||'', e: order.client.endereco||'', x: order.client.complemento||'' },
    r: order.route,
    p: order.payment,
    it: order.items.map(i=>({n:i.name,q:i.qty,pr:i.price})),
  };
  slim.tt = order.items.reduce((s,i)=>s+i.q*i.pr,0);
  return slim;
}

function encodeOrderToHash(order){
  const json = JSON.stringify(buildOrderPayload(order));
  const b64  = btoa(unescape(encodeURIComponent(json))).replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_');
  return `#pedido=${b64}`;
}

async function shareOrder(orderId){
  const o = state.pedidos.find(x=>x.id===orderId); if(!o){ toast("Pedido n√£o encontrado"); return }
  const link = location.origin + location.pathname + encodeOrderToHash(o);

  const lines = [];
  lines.push(`üß∫ *Pedido* (${new Date(o.ts).toLocaleString('pt-BR')})`);
  lines.push(`Cliente: ${o.client.nome}`);
  if(o.client.endereco) lines.push(`Endere√ßo: ${o.client.endereco} ${o.client.complemento||''}`.trim());
  lines.push(`Rota: ${o.route} ‚Ä¢ Pagamento: ${o.payment}`);
  lines.push('Itens:');
  for(const it of o.items){ lines.push(`- ${it.qty} √ó ${it.name} ‚Äî ${brl(it.price)} = ${brl(it.qty*it.price)}`) }
  lines.push(`Total: *${brl(o.total)}*`);
  lines.push('');
  lines.push(`Ver pedido completo: ${link}`);
  const msg = lines.join('\n');

  // 1) Web Share API (melhor UX em iOS/Android)
  if(navigator.share){
    try{
      await navigator.share({ title: 'Pedido', text: msg, url: link });
      toast("Compartilhado");
      return;
    }catch(e){
      // usu√°rio cancelou ou n√£o suportado ‚Äî cair para WhatsApp
    }
  }

  // 2) WhatsApp direto (sem popup bloqueado) + fallback copia
  try{
    const url = waLink(o.client.telefone, msg);
    location.href = url; // evita bloqueio de popup
  }catch{
    // 3) Copia para √°rea de transfer√™ncia
    try{
      await navigator.clipboard.writeText(msg + '\n' + link);
      toast("Copiado. Cole no WhatsApp.");
    }catch{
      alert("Copie e envie:\n\n" + msg + "\n" + link);
    }
  }
}

function openOrderViewer(orderId){
  const o = state.pedidos.find(x=>x.id===orderId); if(!o){ toast("Pedido n√£o encontrado"); return }
  location.hash = encodeOrderToHash(o);
  // hash change vai renderizar
}

/* ===============================
   BACKUP
=================================*/
const btnBackup = document.getElementById('btnBackup');
const fileImport = document.getElementById('fileImport');

btnBackup.addEventListener('click', () => {
  const blob = new Blob([JSON.stringify({
    clientes: state.clientes, produtos: state.produtos, pedidos: state.pedidos
  }, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'backup-cestas.json'; a.click();
  URL.revokeObjectURL(url);
});

fileImport.addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      if(Array.isArray(data.clientes)) state.clientes = data.clientes;
      if(Array.isArray(data.produtos)) state.produtos = data.produtos;
      if(Array.isArray(data.pedidos))  state.pedidos  = data.pedidos;
      saveAll();
      renderClientes(); renderProdutos(); renderRelatorio(); renderCart();
      toast("Backup importado");
    }catch(err){ toast("Arquivo inv√°lido") }
  };
  reader.readAsText(f,'utf-8');
});

/* ===============================
   VISOR DE PEDIDO PELO LINK (#pedido=...)
=================================*/
function tryRenderPedidoFromHash(){
  const h = location.hash || '';
  const m = h.match(/^#pedido=([A-Za-z0-9\-_]+)$/);
  if(!m){ return false }
  const b64 = m[1].replace(/-/g,'+').replace(/_/g,'/');
  try{
    const json = decodeURIComponent(escape(atob(b64)));
    const o = JSON.parse(json);
    renderPedidoView(o);
    show(VIEWS.pedido);
    return true;
  }catch(e){
    toast("Link de pedido inv√°lido");
    return false;
  }
}

function renderPedidoView(o){
  const card = document.getElementById('pedidoCard');
  const when = new Date(o.ts).toLocaleString('pt-BR');
  const total = o.tt ?? o.it.reduce((s,i)=>s+i.q*i.pr,0);
  const tel = o.c?.t || '';
  const telHref = telLink(tel);
  /* >>> Mensagem fixa exigida */
  const waMsg  = "Ol√° aqui e da Cesta B√°sica, estamos chegando";
  const waHref = waLink(tel, waMsg);
  const mapHref = mapsSearch([o.c?.e||'', o.c?.x||''].join(' ').trim());

  const itemsHtml = o.it.map(i=>`
    <tr><td>${escapeHtml(i.n)}</td><td>${i.q}</td><td>${brl(i.pr)}</td><td>${brl(i.q*i.pr)}</td></tr>
  `).join('');

  card.innerHTML = `
    <h3>üßæ Pedido</h3>
    <div class="row" style="justify-content:space-between">
      <div>${when} ‚Ä¢ Rota <b>${escapeHtml(o.r)}</b> ‚Ä¢ Pgto <b>${escapeHtml(o.p)}</b></div>
      <div><span class="badge mono">${escapeHtml(o.id||'')}</span></div>
    </div>
    <div class="hr"></div>
    <div><b>Cliente:</b> ${escapeHtml(o.c?.n||'')}<br>
      <b>Endere√ßo:</b> ${escapeHtml(o.c?.e||'')} ${escapeHtml(o.c?.x||'')}
    </div>
    <div class="hr"></div>
    <div class="table-scroll">
      <table>
        <thead><tr><th>Produto</th><th>Qtd</th><th>Pre√ßo</th><th>Total</th></tr></thead>
        <tbody>${itemsHtml}</tbody>
        <tfoot><tr><th colspan="3" style="text-align:right">Total</th><th>${brl(total)}</th></tr></tfoot>
      </table>
    </div>
    <div class="hr"></div>
    <div class="cta3">
      <a class="btn" ${telHref?`href="${telHref}"`:'aria-disabled="true"'}>Ligar</a>
      <a class="btn primary" target="_blank" ${waHref?`href="${waHref}"`:'aria-disabled="true"'}>WhatsApp</a>
      <a class="btn soft" target="_blank" href="${mapHref}">Google Maps</a>
    </div>
    <div class="hr"></div>
    <a class="link" href="${location.origin+location.pathname}">Voltar para o painel</a>
  `;
}

/* ===============================
   UTIL
=================================*/
function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])) }

/* ===============================
   WIRES
=================================*/
document.getElementById('btnHome').onclick = ()=>show(VIEWS.home);
document.getElementById('btnVender').onclick = ()=>{ show(VIEWS.vender); renderClientes(); renderProdutos(); };
document.getElementById('btnClientes').onclick = ()=>{ show(VIEWS.clientes); renderClientes(); };
document.getElementById('btnProdutos').onclick = ()=>{ show(VIEWS.produtos); renderProdutos(); };
document.getElementById('btnRelatorio').onclick = ()=>{ show(VIEWS.rel); renderRelatorio(); };
document.getElementById('goVender').onclick = ()=>document.getElementById('btnVender').click();
document.getElementById('goClientes').onclick = ()=>document.getElementById('btnClientes').click();
document.getElementById('goProdutos').onclick = ()=>document.getElementById('btnProdutos').click();
document.getElementById('goRelatorio').onclick = ()=>document.getElementById('btnRelatorio').click();

document.getElementById('btnAddCliente').onclick = addCliente;
elC.tbl.addEventListener('click', handleClientesTable);
elC.csv.addEventListener('change', e=>{ if(e.target.files?.[0]) importClientesCSV(e.target.files[0]) });

document.getElementById('btnAddProduto').onclick = addProduto;
elP.tbl.addEventListener('click', handleProdutosTable);

elV.add.onclick = addToCart;
document.getElementById('cartTable').addEventListener('input', handleCart);
document.getElementById('cartTable').addEventListener('click', handleCart);
elV.save.onclick = saveSale;

document.getElementById('relContent').addEventListener('click', handleRelatorio);

document.getElementById('btnBackup').insertAdjacentHTML('afterend',
  '<button class="btn" id="btnImport">Importar</button>');
document.getElementById('btnImport').onclick = ()=>fileImport.click();

/* ===============================
   IN√çCIO
=================================*/
window.addEventListener('hashchange', ()=>{ if(!tryRenderPedidoFromHash()) { /* nada */ } });
if(!tryRenderPedidoFromHash()){ show(VIEWS.home); renderClientes(); renderProdutos(); }

</script>
</body>
</html>
