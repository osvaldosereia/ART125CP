<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Vídeos YouTube</title>
    <!-- Inclui o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define a fonte Inter para todo o corpo do documento */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Estilos para a barra de rolagem (opcional, para um visual mais limpo) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* gray-400 */
        }
        /* Estilo para o dropdown */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* Espaço para o ícone da seta */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
    <!-- Contêiner principal do aplicativo -->
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-4xl flex flex-col lg:flex-row h-[90vh] lg:h-[80vh]">

        <!-- Seção de Controles (Dropdowns e Botões) -->
        <nav class="w-full lg:w-1/3 bg-gray-50 p-4 sm:p-6 border-b lg:border-r border-gray-200 flex flex-col">
            <h1 class="text-3xl font-bold text-gray-900 mb-6 text-center lg:text-left">Buscar Vídeos</h1>

            <div class="mb-4">
                <label for="category-select" class="block text-sm font-medium text-gray-700 mb-2">Selecione uma Categoria:</label>
                <select id="category-select" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm bg-white">
                    <option value="">-- Selecionar Categoria --</option>
                    <!-- As categorias serão injetadas aqui pelo JavaScript -->
                </select>
            </div>

            <button id="search-terms-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors duration-200 mb-6" disabled>
                Buscar Termos
            </button>

            <div id="terms-checkboxes" class="space-y-2 mb-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200 hidden">
                <p class="text-sm font-medium text-gray-700 mb-2">Marque os termos para buscar:</p>
                <!-- Checkboxes serão injetados aqui pelo JavaScript -->
            </div>

            <button id="search-videos-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors duration-200 mb-6" disabled>
                Buscar Vídeos no YouTube
            </button>

            <div id="loading-indicator" class="text-center text-blue-600 hidden">
                <p>Buscando vídeos, por favor aguarde...</p>
                <div class="mt-2 animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        </nav>

        <!-- Seção de Conteúdo Principal (Resultados dos Vídeos) -->
        <main class="flex-1 p-4 sm:p-6 overflow-y-auto">
            <h2 id="main-title" class="text-2xl font-semibold text-gray-900 mb-2"></h2>
            <h3 id="subcategories-intro" class="text-xl text-gray-700 mb-6 pb-2 border-b border-gray-200"></h3>

            <div id="video-results" class="space-y-4">
                <p class="text-gray-500">Selecione uma categoria e clique em "Buscar Termos" para começar.</p>
            </div>
        </main>

    </div>

    <script>
        // Dados do site: categorias e termos de busca pré-definidos
        const categoriesData = [
            {
                id: 'tecnologia',
                name: 'Tecnologia',
                terms: [
                    { id: 'ia-videos', name: 'Inteligência Artificial' },
                    { id: 'dev-web-videos', name: 'Desenvolvimento Web' },
                    { id: 'cybersecurity-videos', name: 'Cibersegurança' },
                    { id: 'cloud-computing-videos', name: 'Computação em Nuvem' },
                    { id: 'data-science-videos', name: 'Ciência de Dados' }
                ]
            },
            {
                id: 'saude-bem-estar',
                name: 'Saúde e Bem-Estar',
                terms: [
                    { id: 'nutricao-videos', name: 'Nutrição Saudável' },
                    { id: 'fitness-videos', name: 'Treino em Casa' },
                    { id: 'meditacao-videos', name: 'Meditação Guiada' },
                    { id: 'yoga-videos', name: 'Aulas de Yoga' },
                    { id: 'saude-mental-videos', name: 'Bem-Estar Mental' }
                ]
            },
            {
                id: 'arte-cultura',
                name: 'Arte e Cultura',
                terms: [
                    { id: 'literatura-videos', name: 'Análise Literária' },
                    { id: 'cinema-videos', name: 'Críticas de Filmes' },
                    { id: 'musica-videos', name: 'História da Música' },
                    { id: 'pintura-videos', name: 'Técnicas de Pintura' },
                    { id: 'teatro-videos', name: 'Peças de Teatro' }
                ]
            },
            {
                id: 'viagens-aventura',
                name: 'Viagens e Aventura',
                terms: [
                    { id: 'destinos-exoticos-videos', name: 'Destinos Exóticos' },
                    { id: 'mochilao-videos', name: 'Dicas de Mochilão' },
                    { id: 'esportes-radicais-videos', name: 'Esportes Radicais' },
                    { id: 'viagem-economica-videos', name: 'Viagem Econômica' },
                    { id: 'natureza-videos', name: 'Trilhas e Natureza' }
                ]
            }
        ];

        // Referências aos elementos do DOM
        const categorySelect = document.getElementById('category-select');
        const searchTermsBtn = document.getElementById('search-terms-btn');
        const termsCheckboxesDiv = document.getElementById('terms-checkboxes');
        const searchVideosBtn = document.getElementById('search-videos-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const mainTitle = document.getElementById('main-title');
        const subcategoriesIntro = document.getElementById('subcategories-intro');
        const videoResultsDiv = document.getElementById('video-results');

        // Variáveis de estado
        let selectedCategory = null;

        /**
         * Popula o dropdown de categorias.
         */
        function populateCategoryDropdown() {
            categorySelect.innerHTML = '<option value="">-- Selecionar Categoria --</option>';
            categoriesData.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }

        /**
         * Exibe os termos de busca como checkboxes com base na categoria selecionada.
         */
        function displaySearchTerms() {
            termsCheckboxesDiv.innerHTML = '<p class="text-sm font-medium text-gray-700 mb-2">Marque os termos para buscar:</p>';
            videoResultsDiv.innerHTML = ''; // Limpa resultados anteriores
            mainTitle.textContent = '';
            subcategoriesIntro.textContent = '';
            searchVideosBtn.disabled = true; // Desabilita o botão de buscar vídeos

            if (!selectedCategory) {
                termsCheckboxesDiv.classList.add('hidden');
                return;
            }

            termsCheckboxesDiv.classList.remove('hidden');
            mainTitle.textContent = selectedCategory.name;
            subcategoriesIntro.textContent = 'Escolha os termos de busca:';

            selectedCategory.terms.forEach(term => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="term-${term.id}" value="${term.name}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="term-${term.id}" class="ml-2 block text-sm text-gray-900">${term.name}</label>
                `;
                termsCheckboxesDiv.appendChild(div);
            });

            // Habilita o botão de buscar vídeos se houver termos selecionáveis
            const checkboxes = termsCheckboxesDiv.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
                    searchVideosBtn.disabled = !anyChecked;
                });
            });
        }

        /**
         * Função auxiliar para tentar fazer fetch com exponential backoff.
         * @param {string} url - URL para a requisição.
         * @param {Object} options - Opções para a requisição fetch.
         * @param {number} retries - Número máximo de tentativas.
         * @param {number} delay - Atraso inicial em milissegundos.
         * @returns {Promise<Response>} A resposta da requisição bem-sucedida.
         * @throws {Error} Se todas as tentativas falharem ou se houver um erro não-retentável.
         */
        async function retryFetch(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    } else {
                        const errorBody = await response.text();
                        console.warn(`Tentativa ${i + 1} falhou com status ${response.status}: ${response.statusText}. Detalhes: ${errorBody}`);
                        // Tentar novamente em caso de erros de servidor ou "Too Many Requests"
                        if (response.status === 429 || response.status >= 500) {
                            await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                        } else {
                            // Para outros erros (ex: 400, 401, 403, 404), não tentar novamente, lançar imediatamente
                            throw new Error(`Erro na API: ${response.status} - ${response.statusText}. Detalhes: ${errorBody}`);
                        }
                    }
                } catch (error) {
                    console.error(`Erro na tentativa ${i + 1} de fetch:`, error);
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                    } else {
                        throw error; // Lançar erro após todas as tentativas
                    }
                }
            }
            throw new Error('Todas as tentativas de fetch falharam.');
        }

        /**
         * Busca vídeos no YouTube (simulado via LLM) com base nos termos selecionados.
         */
        async function searchYouTubeVideos() {
            const selectedTerms = Array.from(termsCheckboxesDiv.querySelectorAll('input[type="checkbox"]:checked'))
                                     .map(cb => cb.value);

            if (selectedTerms.length === 0) {
                videoResultsDiv.innerHTML = '<p class="text-red-500">Por favor, selecione pelo menos um termo de busca.</p>';
                return;
            }

            loadingIndicator.classList.remove('hidden');
            videoResultsDiv.innerHTML = ''; // Limpa resultados anteriores
            searchVideosBtn.disabled = true; // Desabilita o botão durante a busca

            const prompt = `Gere um array JSON de até 50 objetos de vídeo do YouTube. Cada objeto deve ter 'title', 'url' (use 'https://www.youtube.com/watch?v=VIDEO_ID_ALEATORIO'), 'thumbnail' (use 'https://placehold.co/1280x720?text=Video'), 'description' e 'publishDate' (dentro dos últimos 60 dias a partir de hoje, 07 de agosto de 2025, no formato YYYY-MM-DD). Os vídeos devem ser relevantes para os seguintes termos de busca: ${selectedTerms.join(', ')}. Garanta variedade nos títulos e descrições.`;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING" },
                                "url": { "type": "STRING" },
                                "thumbnail": { "type": "STRING" },
                                "description": { "type": "STRING" },
                                "publishDate": { "type": "STRING" }
                            },
                            "required": ["title", "url", "thumbnail", "description", "publishDate"]
                        }
                    }
                }
            };

            const apiKey = ""; // Deixe como está. O Canvas fornecerá a chave em tempo de execução.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                // Usar a função retryFetch para a chamada da API
                const response = await retryFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const json = result.candidates[0].content.parts[0].text;
                    try {
                        const videos = JSON.parse(json);
                        renderVideoResults(videos);
                    } catch (jsonError) {
                        console.error('Erro ao fazer parse do JSON da API:', jsonError, 'JSON recebido:', json);
                        videoResultsDiv.innerHTML = `<p class="text-red-500">Erro ao processar a resposta da API (JSON inválido). Por favor, tente novamente.</p>`;
                    }
                } else {
                    console.warn('Resposta da API não contém candidatos ou conteúdo esperado:', result);
                    videoResultsDiv.innerHTML = '<p class="text-gray-500">Nenhum vídeo encontrado para os termos selecionados. Tente outros termos.</p>';
                }
            } catch (error) {
                console.error('Erro ao buscar vídeos:', error);
                videoResultsDiv.innerHTML = `<p class="text-red-500">Ocorreu um erro ao buscar vídeos: ${error.message}. Por favor, tente novamente.</p>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                searchVideosBtn.disabled = false; // Habilita o botão novamente
            }
        }

        /**
         * Renderiza os resultados dos vídeos na interface.
         * @param {Array<Object>} videos - Um array de objetos de vídeo.
         */
        function renderVideoResults(videos) {
            videoResultsDiv.innerHTML = ''; // Limpa resultados anteriores
            if (videos.length === 0) {
                videoResultsDiv.innerHTML = '<p class="text-gray-500">Nenhum vídeo encontrado para os termos selecionados.</p>';
                return;
            }

            mainTitle.textContent = `Resultados para: ${selectedCategory.name}`;
            subcategoriesIntro.textContent = `Vídeos encontrados (${videos.length}):`;

            videos.forEach(video => {
                const videoCard = document.createElement('div');
                videoCard.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4';
                videoCard.innerHTML = `
                    <div class="flex-shrink-0 w-full sm:w-48 h-28 rounded-md overflow-hidden">
                        <img src="${video.thumbnail}" alt="Thumbnail do vídeo" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <h4 class="text-lg font-semibold text-gray-800 mb-1">
                            <a href="${video.url}" target="_blank" rel="noopener noreferrer" class="hover:text-blue-600 transition-colors duration-200">${video.title}</a>
                        </h4>
                        <p class="text-sm text-gray-600 mb-2">${video.description}</p>
                        <p class="text-xs text-gray-500">Publicado em: ${video.publishDate}</p>
                    </div>
                `;
                videoResultsDiv.appendChild(videoCard);
            });
        }

        // --- Event Listeners ---
        categorySelect.addEventListener('change', (event) => {
            const categoryId = event.target.value;
            selectedCategory = categoriesData.find(cat => cat.id === categoryId) || null;

            // Reseta o estado
            termsCheckboxesDiv.classList.add('hidden');
            termsCheckboxesDiv.innerHTML = '';
            searchTermsBtn.disabled = !selectedCategory; // Habilita/desabilita "Buscar Termos"
            searchVideosBtn.disabled = true; // Desabilita "Buscar Vídeos"
            loadingIndicator.classList.add('hidden');
            mainTitle.textContent = selectedCategory ? selectedCategory.name : '';
            subcategoriesIntro.textContent = selectedCategory ? 'Clique em "Buscar Termos" para continuar.' : '';
            videoResultsDiv.innerHTML = selectedCategory ? '<p class="text-gray-500">Clique em "Buscar Termos" para ver as opções.</p>' : '<p class="text-gray-500">Selecione uma categoria e clique em "Buscar Termos" para começar.</p>';
        });

        searchTermsBtn.addEventListener('click', displaySearchTerms);

        searchVideosBtn.addEventListener('click', searchYouTubeVideos);

        // Inicializa o site ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            populateCategoryDropdown();
            mainTitle.textContent = '';
            subcategoriesIntro.textContent = '';
            videoResultsDiv.innerHTML = '<p class="text-gray-500">Selecione uma categoria e clique em "Buscar Termos" para começar.</p>';
        });
    </script>
</body>
</html>
